import random

class Runs_tests:
    def __init__(self, data):
        self.data = data
        self.ret = []
        for i in range(len(self.data)-1):
            if self.data[i] > self.data[i+1]:
                self.ret.append(-1)
            else:
                self.ret.append(1)

    def num_directional_runs(self):
        num_runs = 0
        if len(self.ret) > 0:
            num_runs += 1
        for i in range(1, len(self.ret)):
            if self.ret[i] != self.ret[i-1]:
                num_runs += 1
        return num_runs

    def len_directional_runs(self):
        max_run = 0
        run = 1
        for i in range(1, len(self.ret)):
            if self.ret[i] == self.ret[i-1]:
                run += 1
            else:
                if run > max_run:
                    max_run = run
                run = 1
        if run > max_run:
            max_run = run
        return max_run

    def num_increases_decreases(self):
        positive = 0
        for i in range(len(self.ret)):
            if self.ret[i] == 1:
                positive += 1
        reverse_positive = len(self.ret) - positive
        if positive > reverse_positive:
            return positive
        else:
            return reverse_positive

    def calculate_all_test_statistics(self):
        num_directional_runs = self.num_directional_runs()
        len_directional_runs = self.len_directional_runs()
        num_increases_decreases = self.num_increases_decreases()

        return num_directional_runs, len_directional_runs, num_increases_decreases


def fisher_yates_shuffle(sequence):
    for i in range(len(sequence) - 1, 0, -1):
        j = random.randint(0, i)
        sequence[i], sequence[j] = sequence[j], sequence[i]
    return sequence

def permutation_test(S):
    S = list(S)
    runs_tests = Runs_tests(S)
    Ti = runs_tests.calculate_all_test_statistics()
    print(Ti)
    C = [0, 0, 0]

    for _ in range(10000):
        S = fisher_yates_shuffle(S)
        runs_tests = Runs_tests(S)
        T = runs_tests.calculate_all_test_statistics()

        for i in range(3):
            if T[i] > Ti[i]:
                C[i] += 1
            elif T[i] == Ti[i]:
                C[i] += 1
    print(C)
    for i in range(3):
        if C[i] <= 5 or C[i] >= 9995:
            return "Reject the IID assumption"
    return "Assume that the noise source outputs are IID"

# Test the function
seq = '0111010111001011001100011110010110000000101111001100111100000100000101100110000101111100101010011010000000110010101000110110110010110110110000010110110000010111110010111001000011101111011111000100010001111000110100001000000111001101101110010001110011001001101011111010011101111010000011010111001011001110110000100111111101011111111000101110110101100100111010101110101110001001110010110101010000111101011101100001101100011010001101010010101000110001111111111110100110110101100111000110011010001110111010111101000110011100001111101101100110000001001101010110101100010000101010001010010010110111111111100101100010111111010010011001010011010001010000101000010111011010100011010011010100010110001100011111100111010111110111000110100101001001001001110110000010100011101101101010001100000101000100101110010000100001100111011010100110111010010110111010101000111111110101000101100111100110101110101111111000001110000001000101111000011101101001010000000101000101011111101100010101110010011111100110110010101010100101100000110010110001100001101010000111101110101000110101101101111011111001110011000001000101001011100100000000001100000000100011011101000000110111011101101011010011010111000001010100100000001000010101000000100110001111101110000100101111111101000010011110001010110010101010011100001001110000000101111011010000001010101000010111111111111110110000111010000001101011010100000010110111011000011100001011101011000010001001011011001110010111011110010100001011101000111110111101111011111101011000101101011000111001011000111001010000101100100110100110010101000011001100110100101000011010101110000010000011001001100000100010100011100100111101010100111110100001010111100010011000111111010001010000010001111110011000010111001001101110011011001010100000101101000100111100000101010111100011011000111111010001111011111101100001000100011010001101000010000011011101101010011001101100000110001000001111000110000010001011100111010001011011011001101011101010111100101101010001000111000010101100010100101000100100100001100100111110101100000000111010100001110100011001011111011000010010000001010000000011011010010010100111110101011110101111110011010110111111011011000110011110011100111111100010000000111010001100111100001100111011111100010000010011000010000111011011001110010001111010011110110011000001111000000011110001101110010011000101000110001100010101111101000111011000101110111010010111101000101101100010110110111110000110011011111101000011010100110001110101110110110011000111100111001110111010001110111111110101010011101000000000000011100001110100000011100100011111101111111001000110111111011111000110011110011110010001010011111101001010111000101110111101011010100000111011000001100001101111101110101100000100010001001101101001101011100011100001001110101101010101111000001111100110110110101010100101100010011100000000011100011010110011111100011001010100110001010000101011010000101001110000101001110001101011011111011010001001000110100010001000011110101101101110011110101011110111110111101010101111110010011100000100011100011010110001010010101000101001000001100100111001100001001000101100000010100011001000110111101111101011010011001001011011000100000111110101111100010100110100110001010111100110011000111111010011111110100000000011101000100011011011011111111010010110001011111111100111010100110000110101110110110011101100001011010001100110000011111011011001001011111111001010110111001001001110001110111100111010110101001101110000010101111001111110110001101110100000111100101111010000010000011011000101110100001100010101100011011101001000001001000111111110111100111111011100001111011100110001011001101100100011111110000000110111001001100001101000011000100011100001111011110000110110011100100011000110001010001100010100000110000000101011001100111100000110101011010111111000001100011110001000110001010011110100011101100000010101011000100011010010000010011001101010011001000101000100100110101110111011110010110101001110100111001101000110010001110011011001000000010110001000011101001001100100100100000111101100101011'
print(permutation_test(seq))


def read_sequences(file_name_):
    with open(file_name_, 'r') as file:                      # open the file in a read mode
        _sequences = []                                      # set a buffer to store the sequences
        for line in file:
            stripped_line = line.strip()                     # extract each sequence as a separate line
            mapped_line = list(map(int, stripped_line))      # convert each line to the list of integers
            _sequences.append(mapped_line)                   # append each sequence as a list to the buffer
    return _sequences                                        # return the list of sequences


def Runs_of_all_sequences(seq_):
    all_runs = []                                          # set a buffer to store the normalised gaps
    for sequence in seq_:
        statics = permutation_test(sequence)
        all_runs.append(statics)   # set them with a descending order to ease the further part
    return all_runs


sequences = read_sequences('../RBG_data_files/AES_DRBG.txt')       # collect All the sequences
# sequences = '0111010111001011001100011110010110000000101111001100111100000100000101100110000101111100101010011010000000110010101000110110110010110110110000010110110000010111110010111001000011101111011111000100010001111000110100001000000111001101101110010001110011001001101011111010011101111010000011010111001011001110110000100111111101011111111000101110110101100100111010101110101110001001110010110101010000111101011101100001101100011010001101010010101000110001111111111110100110110101100111000110011010001110111010111101000110011100001111101101100110000001001101010110101100010000101010001010010010110111111111100101100010111111010010011001010011010001010000101000010111011010100011010011010100010110001100011111100111010111110111000110100101001001001001110110000010100011101101101010001100000101000100101110010000100001100111011010100110111010010110111010101000111111110101000101100111100110101110101111111000001110000001000101111000011101101001010000000101000101011111101100010101110010011111100110110010101010100101100000110010110001100001101010000111101110101000110101101101111011111001110011000001000101001011100100000000001100000000100011011101000000110111011101101011010011010111000001010100100000001000010101000000100110001111101110000100101111111101000010011110001010110010101010011100001001110000000101111011010000001010101000010111111111111110110000111010000001101011010100000010110111011000011100001011101011000010001001011011001110010111011110010100001011101000111110111101111011111101011000101101011000111001011000111001010000101100100110100110010101000011001100110100101000011010101110000010000011001001100000100010100011100100111101010100111110100001010111100010011000111111010001010000010001111110011000010111001001101110011011001010100000101101000100111100000101010111100011011000111111010001111011111101100001000100011010001101000010000011011101101010011001101100000110001000001111000110000010001011100111010001011011011001101011101010111100101101010001000111000010101100010100101000100100100001100100111110101100000000111010100001110100011001011111011000010010000001010000000011011010010010100111110101011110101111110011010110111111011011000110011110011100111111100010000000111010001100111100001100111011111100010000010011000010000111011011001110010001111010011110110011000001111000000011110001101110010011000101000110001100010101111101000111011000101110111010010111101000101101100010110110111110000110011011111101000011010100110001110101110110110011000111100111001110111010001110111111110101010011101000000000000011100001110100000011100100011111101111111001000110111111011111000110011110011110010001010011111101001010111000101110111101011010100000111011000001100001101111101110101100000100010001001101101001101011100011100001001110101101010101111000001111100110110110101010100101100010011100000000011100011010110011111100011001010100110001010000101011010000101001110000101001110001101011011111011010001001000110100010001000011110101101101110011110101011110111110111101010101111110010011100000100011100011010110001010010101000101001000001100100111001100001001000101100000010100011001000110111101111101011010011001001011011000100000111110101111100010100110100110001010111100110011000111111010011111110100000000011101000100011011011011111111010010110001011111111100111010100110000110101110110110011101100001011010001100110000011111011011001001011111111001010110111001001001110001110111100111010110101001101110000010101111001111110110001101110100000111100101111010000010000011011000101110100001100010101100011011101001000001001000111111110111100111111011100001111011100110001011001101100100011111110000000110111001001100001101000011000100011100001111011110000110110011100100011000110001010001100010100000110000000101011001100111100000110101011010111111000001100011110001000110001010011110100011101100000010101011000100011010010000010011001101010011001000101000100100110101110111011110010110101001110100111001101000110010001110011011001000000010110001000011101001001100100100100000111101100101011'
Runs = Runs_of_all_sequences(sequences)  # all normalised gaps
# print(sequences)
